<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="comment">
	<delete id="deleteComment">
		<![CDATA[
			DELETE FROM COMMENT WHERE USER_ID=#{user_id} AND MOVIE_ID=#{movie_id}
		]]>
	</delete>
	<update id="modifyComment">
		<![CDATA[
			UPDATE COMMENT SET COMMENT=#{comment} WHERE USER_ID=#{user_id} AND MOVIE_ID=#{movie_id}
		]]>
	</update>
	<insert id="insertComment">
		<![CDATA[
			INSERT INTO comment(COMMENT, USER_ID, MOVIE_ID, REPLY_CNT) 
			VALUES(#{comment}, #{user_id}, #{movie_id},
			(SELECT COUNT(b.reply_id)
			FROM comment a
			LEFT JOIN reply b ON a.comment_id = b.comment_id
			WHERE a.comment_id = #{comment_id}))
		]]>
	</insert>
	<update id="updateLike">
		<![CDATA[
			UPDATE COMMENT SET LIKE_CNT=#{like_cnt+1} WHERE USER_ID=#{user_id}
		]]>
	</update>
	<select id="getComment" resultType="comment">
		<![CDATA[
	        SELECT * FROM COMMENT WHERE MOVIE_ID=#{movie_id} AND USER_ID=#{user_id}
	    ]]>
	</select>
	<select id="getCommentList" resultType="curComment">
		<![CDATA[
	        SELECT b.profile_img, a.nickname, c.comment_id, c.comment, c.write_time, c.modify_time, 
	        c.views, c.user_id, c.movie_id, COALESCE(d.rating, 0.0) AS rating
			FROM user a
			JOIN user_detail b ON a.id = b.user_id
			JOIN comment c ON c.user_id = a.id
            LEFT JOIN rating d ON d.user_id = a.id
			where c.movie_id = #{movie_id}
			order by c.reply_cnt desc;
	    ]]>
	</select>
	<select id="getCurComment" resultType="curComment">
		<![CDATA[
	        SELECT b.profile_img, a.nickname, c.comment_id, c.comment, c.write_time, c.modify_time,
	        c.views, c.reply_cnt, c.user_id, c.movie_id, COALESCE(d.rating, 0.0) AS rating
			FROM user a
			JOIN user_detail b ON a.id = b.user_id
			JOIN comment c ON c.user_id = a.id
			LEFT JOIN rating d ON d.user_id = a.id
			where c.comment_id=#{comment_id} and c.movie_id=#{movie_id};
	    ]]>
	</select>
	<update id="curCommentView">
	    <![CDATA[
	        UPDATE COMMENT SET views=views+1 WHERE comment_id=#{comment_id} and movie_id=#{movie_id};
	    ]]>
	</update>
</mapper>